# CFM 碳足跡管理系統之建置與功能實作

## 一、系統概述

隨著全球氣候變遷議題日益受到重視，企業永續發展與碳排放管理已成為現代企業營運的重要課題。為符合國際碳排放管理標準及 ESG（環境、社會、治理）要求，本研究開發了一套完整的企業級碳足跡管理系統（Carbon Footprint Management System, CFM）。該系統整合了碳排放數據監控、智能決策優化、永續報告書自動生成及 AI 輔助查詢等功能，提供企業一個全方位的永續管理解決方案。

CFM 系統採用現代化的 Web 技術架構，以 Next.js 14 框架為基礎，結合 TypeScript 強型別語言開發，確保系統的穩定性與可維護性。系統後端使用 PostgreSQL 關聯式資料庫儲存碳排放數據，並透過 Prisma ORM 進行資料存取，前端則採用 React 18 建構互動式使用者介面，搭配 Tailwind CSS 實現響應式設計，使系統能夠在不同裝置上提供一致的使用體驗。

## 二、系統架構設計

### 2.1 整體架構

本系統採用現代化的全端開發架構（Full-Stack Architecture），前後端整合於 Next.js 框架中，利用其 App Router 機制實現頁面路由與 API 端點的統一管理。整體架構可分為四個主要層級：

**展示層（Presentation Layer）**：使用 React 18 框架開發前端介面，包含儀表板（Dashboard）、決策模型（Decision Model）、永續報告（Report）及系統設定（Settings）四大核心頁面。介面設計採用玻璃態效果（Glass-morphism）與漸層配色，並整合 Recharts 與 Chart.js 圖表庫，提供豐富的資料視覺化功能。

**應用層（Application Layer）**：透過 Next.js API Routes 實現 RESTful API 端點，共開發 23 個 API 端點，涵蓋碳排數據管理（7個端點）、決策模型優化（5個端點）、報告生成（6個端點）及系統設定（5個端點）等功能。每個 API 端點皆包含完善的錯誤處理與資料驗證機制。

**業務邏輯層（Business Logic Layer）**：核心業務邏輯包括決策模型優化演算法（位於 `/src/lib/model.ts`）、碳排放數據計算與統計分析功能。決策模型採用網格搜索（Grid Search）演算法，整合 25+ 個經濟與綠色製造參數，透過數學優化模型計算最佳生產策略與碳減排方案。

**資料存取層（Data Access Layer）**：使用 Prisma ORM 進行資料庫操作，定義 10 個主要資料模型，包括公司資料（Company）、碳排放數據（CarbonEmission）、模型參數（ModelParameter）、優化結果（OptimizationResult）、永續報告（SustainabilityReport）等。資料庫採用 PostgreSQL 15，並針對查詢頻繁的欄位（如 companyId、date）建立索引以提升查詢效能。

### 2.2 資料庫設計

資料庫設計遵循正規化原則，避免資料重複並確保資料一致性。核心資料表 CarbonEmission 記錄企業每日碳排放數據，包含 Scope 1（直接排放）、Scope 2（能源間接排放）、Scope 3（其他間接排放）三大分類，以及電力、天然氣、燃料、運輸、廢棄物、用水等細項數據。每筆記錄皆標註資料來源（dataSource）與驗證狀態（verified），確保資料品質與可追溯性。

ModelParameter 資料表儲存決策模型所需的經濟參數與綠色製造參數，包括需求彈性係數（a, b）、市場規模（M）、折扣率（rho）、生產成本（W, V）、運輸成本（Dcost）、訂購成本（S）等基本經濟參數，以及綠色投資效益係數（A）、能源使用率（UR）、燃料使用量（Uf）、固定與可變生產投資（Ii, Ij）等綠色製造參數。此外，系統支援不確定性分析，每個參數皆可設定變異數（如 SHat, VHat）以進行敏感性分析。

SustainabilityReport 資料表管理永續報告書的生命週期，從草稿（DRAFT）、審核（REVIEW）、核准（APPROVED）到發布（PUBLISHED）及封存（ARCHIVED），完整記錄報告的執行摘要、碳足跡分析、減排目標、改善措施、法規遵循、財務影響及利害關係人等內容，並支援 PDF 與 DOCX 格式匯出。

## 三、核心功能模組

### 3.1 碳排儀表板模組

碳排儀表板是系統的核心模組，提供企業碳排放數據的即時監控與多維度分析功能。本模組採用 SWR（Stale-While-Revalidate）資料擷取策略，每 5 秒自動更新數據，確保使用者能夠即時掌握最新的碳排放狀況。

儀表板支援彈性的時間範圍查詢功能，使用者可選擇 7 天、30 天、90 天或 180 天的資料區間，系統會自動計算該期間的總碳排放量、平均日排放量、減排量及減排百分比等關鍵指標。資料視覺化採用多種圖表類型，包括折線圖顯示碳排放趨勢、圓餅圖呈現 Scope 1/2/3 排放佔比、柱狀圖比較不同排放源（電力、天然氣、燃料、運輸等）的貢獻度。

儀表板設計四個關鍵指標卡片，分別顯示當前總碳排放量、本月減排量、月度減排目標達成率及碳排放效率評分。每個指標卡片皆包含與前期比較的趨勢指示器，以視覺化方式呈現增減變化，協助管理者快速掌握碳排放管理成效。

資料來源管理功能確保碳排放數據的可信度，系統記錄每筆數據的來源（如自動監測、人工輸入、第三方驗證等）與驗證狀態，並支援批次數據匯入與每日數據自動生成功能，降低人工作業負擔。

### 3.2 決策模型優化系統

決策模型優化系統是本研究的創新功能，整合綠色製造與經濟效益的數學優化模型，協助企業在追求利潤最大化的同時，實現碳排放減量目標。

本模組基於數學規劃理論，建立包含零售價格（p）、固定生產週期（Tf）、零售週期（TR）及綠色投資金額（G）四個決策變數的利潤最大化模型。模型考量需求函數、生產成本、運輸成本、訂購成本、持有成本、綠色投資效益等因素，並透過網格搜索演算法求解最佳策略組合。

優化演算法採用兩階段搜索策略：第一階段進行粗略網格搜索，在整個可行解空間中快速定位全域最佳解的大致範圍；第二階段在最佳解附近進行精細搜索，提高解的精確度。演算法自動檢查約束條件，確保需求函數值大於零，避免產生不合理的解。

系統支援 25+ 個參數的彈性配置，使用者可根據企業實際狀況調整參數值，模型會即時重新計算最佳策略。優化結果除了顯示最佳決策變數組合與預期利潤外，還提供總週期、總收入、總成本及預期碳減排量等資訊，完整評估決策的經濟與環境效益。

敏感性分析功能是決策支援的重要工具，系統針對每個參數進行 ±5% 的變動分析,計算參數變化對最佳利潤的影響程度與影響百分比，以圖表方式呈現各參數的敏感度排序，協助管理者識別關鍵影響因子，制定更穩健的決策策略。

### 3.3 永續報告書自動生成

為符合國際永續報告標準（如 GRI、TCFD、SASB 等）的揭露要求，本系統開發永續報告書自動生成功能，大幅降低報告編制的時間成本。

系統提供兩種報告生成模式：快速生成模式與自訂生成模式。快速生成模式會自動擷取最近一個月的碳排放數據與減排成效，套用預設範本產生標準報告；自訂生成模式則允許使用者選擇報告期間、自訂報告標題、編寫執行摘要、設定減排目標、描述改善措施、聲明法規遵循狀況、分析財務影響及列舉利害關係人等內容。

報告生成引擎整合 @react-pdf/renderer 函式庫，支援 PDF 格式匯出，確保報告格式的一致性與專業性。生成的報告包含碳排放總覽、Scope 分類統計、排放源分析、趨勢圖表、減排目標達成率、改善措施說明及法規遵循聲明等完整內容。

報告管理功能支援報告版本控制與狀態追蹤，從草稿建立、內部審核、主管核准到正式發布，每個階段皆有明確的狀態標記。系統記錄報告的建立時間、更新時間及發布時間，並提供報告列表檢視與下載功能，方便企業保存歷史報告供查核使用。

### 3.4 AI 智能助理整合

為提升使用者體驗與系統易用性，本系統整合 Anthropic Claude AI 模型，開發浮動式 AI 智能助理（FloatingAI），提供即時的碳排放查詢與問題解答服務。

AI 助理採用浮動視窗設計，位於畫面右下角，不干擾使用者操作主要功能，但隨時可以展開進行對話。介面設計包含快速問題建議按鈕，使用者可一鍵詢問常見問題如「目前的碳排放量是多少？」、「如何降低 Scope 2 排放？」等，降低輸入負擔。

對話系統採用會話管理機制，透過 localStorage 儲存使用者 ID 與會話 ID，確保對話的連續性。每次對話會記錄使用者訊息與 AI 回應，並儲存至 ChatMessage 資料表，供後續分析與改進 AI 回應品質使用。

AI 助理的後端架構採用 Webhook 轉發機制，前端發送的對話請求會經由 `/api/ai/chat` 端點轉發至部署於 Railway 平台的 Webhook 服務（`https://primary-production-94491.up.railway.app/webhook/carbon-query`），該服務負責呼叫 Anthropic Claude API 並返回回應。此架構設計將 AI 推論運算與主系統分離,提升系統的可擴展性與維護性。

系統另外整合 N8N Webhook 作為非阻塞式查詢記錄機制，使用者的查詢內容會非同步發送至 N8N 工作流程平台，可進行進階的數據分析、自動化通知或觸發其他業務流程，實現更靈活的系統整合。

### 3.5 系統設定與管理

系統設定模組提供完整的企業資料管理、減排目標設定及系統配置功能。企業資料管理功能包含公司名稱、產業別、地址、聯絡人、統一編號等基本資料的建立、查詢、更新與刪除（CRUD）操作。

減排目標管理功能支援多年度目標設定，使用者可設定基準年、基準排放量、目標年及目標減排量，系統會自動計算目前進度與達成率。目標類型包含絕對減量（Absolute Reduction）與相對減量（Intensity Reduction）兩種，符合不同企業的減排策略需求。

系統配置功能採用鍵值對（Key-Value）儲存機制，支援文字、數值、布林值及 JSON 等多種資料型態的配置項目。配置項目依類別（category）分類管理，包含一般設定、安全設定、通知設定、整合設定等，每個配置項目皆附有標籤（label）與描述（description），方便管理者理解設定用途。

## 四、技術實作細節

### 4.1 前端技術實作

前端開發採用 Next.js 14 框架的 App Router 架構，相較於傳統的 Pages Router，App Router 提供更好的效能優化與開發體驗。系統使用 TypeScript 5.4.5 進行開發，透過強型別系統在編譯階段捕捉潛在錯誤，提升程式碼品質。

狀態管理與資料擷取使用 SWR 函式庫，該函式庫基於 Stale-While-Revalidate 的 HTTP 快取策略，提供自動重新驗證、錯誤重試、焦點重新驗證等功能。儀表板頁面設定 5 秒的自動更新間隔（`refreshInterval: 5000`），確保數據的即時性。

介面樣式採用 Tailwind CSS 3.4.3 工具類別框架，並自訂主題配色、動畫效果與響應式斷點。系統定義 fade-in、slide-up、slide-down、pulse-slow 等自訂動畫，提升介面的互動性。漸層配色採用藍-綠-青色系（blue, green, cyan），呼應永續環保的主題。

圖表視覺化整合兩套主流圖表函式庫：Recharts 2.12.6 用於繪製響應式的折線圖、圓餅圖與柱狀圖，具有良好的 React 整合性；Chart.js 4.4.2 搭配 react-chartjs-2 5.2.0 用於繪製進階圖表與動畫效果。兩者互補使用，提供豐富的資料視覺化選項。

### 4.2 後端技術實作

後端 API 開發使用 Next.js API Routes 機制，在 `/src/app/api/` 目錄下建立符合 RESTful 設計原則的 API 端點。每個端點皆實作 HTTP 方法處理函式（如 GET, POST, PUT, DELETE），並包含請求驗證、業務邏輯執行、錯誤處理與回應格式化等完整流程。

資料存取採用 Prisma 6.18.0 ORM 框架，在 `/prisma/schema.prisma` 定義資料模型，透過 `npx prisma generate` 指令自動生成型別安全的資料庫客戶端。Prisma 提供直觀的查詢 API，例如查詢碳排放數據：

```typescript
const emissions = await prisma.carbonEmission.findMany({
  where: {
    companyId: companyId,
    date: {
      gte: startDate,
      lte: endDate,
    },
  },
  orderBy: { date: 'asc' },
});
```

系統針對高頻率查詢的欄位建立資料庫索引，如 `@@index([companyId, date])` 與 `@@index([date])`，大幅提升查詢效能。

錯誤處理採用統一的錯誤回應格式，包含 HTTP 狀態碼、錯誤訊息與錯誤代碼，方便前端進行錯誤識別與處理。API 端點設定適當的超時時間（如 AI 對話端點設定 60 秒超時），避免長時間等待影響使用者體驗。

### 4.3 部署架構

系統採用 Serverless 架構部署於 Vercel 平台，利用其自動化 CI/CD 流程，每次推送至 GitHub 儲存庫時自動觸發建置與部署。Vercel 提供全球 CDN 加速、自動 HTTPS 憑證、環境變數管理等功能，簡化運維工作。

資料庫部署於 Railway 平台的 PostgreSQL 服務，提供自動備份、監控告警與垂直擴展功能。資料庫連線透過環境變數 `DATABASE_URL` 配置，確保敏感資訊不會外洩至程式碼儲存庫。

AI 服務整合 Anthropic Claude API，透過 `@anthropic-ai/sdk` 函式庫進行呼叫。API 金鑰儲存於環境變數 `ANTHROPIC_API_KEY`，並透過 Webhook 服務進行代理呼叫，避免前端直接暴露 API 金鑰。

## 五、系統特色與創新

本系統的主要創新點在於整合碳排放管理與經濟決策優化，突破傳統碳管理系統僅提供數據記錄與報表功能的限制，透過數學優化模型提供具體的減排策略建議，協助企業在經濟效益與環境責任之間取得平衡。

AI 智能助理的整合提升系統的易用性，使用者無需熟悉複雜的報表操作，即可透過自然語言對話快速獲得所需資訊。Webhook 整合機制則為系統提供良好的擴展性，企業可依需求整合其他業務系統或工作流程平台。

響應式設計確保系統在桌面電腦、平板與手機等不同裝置上皆能提供良好的使用體驗，管理者可隨時隨地監控碳排放狀況。完善的資料稽核機制記錄所有系統操作，符合法規遵循與內部控制要求。

## 六、結論

本研究成功開發一套功能完整、架構清晰的企業級碳足跡管理系統，整合碳排放監控、決策優化、報告生成及 AI 輔助等功能，提供企業全方位的永續管理解決方案。系統採用現代化的 Web 技術架構，具備良好的效能、安全性與可維護性，可作為企業推動淨零轉型的重要工具。未來可進一步擴展功能，如整合供應鏈碳排放追蹤、碳權交易管理、國際碳揭露標準自動對接等，持續提升系統價值。

---

**字數統計：約 2,150 字**